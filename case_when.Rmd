---
title: "case_when examples (McNamara DSS Collection)"
author: "Nicholas Horton (nhorton@amherst.edu)"
date: "June 30, 2016"
output:
  html_document:
    fig_height: 3
    fig_width: 5
  pdf_document:
    fig_height: 3
    fig_width: 5
  word_document:
    fig_height: 3
    fig_width: 5
---

```{r, setup, include=FALSE}
require(mosaic)   # Load additional packages here 

# Some customization.  You can alter or delete as desired (if you know what you are doing).
trellis.par.set(theme=theme.mosaic()) # change default color scheme for lattice
knitr::opts_chunk$set(
  tidy=FALSE,     # display code as typed
  size="small")   # slightly smaller font for code
```

```{r}
library(dplyr); library(mosaic); library(readr)
```

### Task 1: creating categorical variable (drinking status)

The National Institutes of Alcohol Abuse and Alcoholism have published guidelines for moderate drinking.  These state that women, or men aged 65 or older should drink no more than one drink per day on average and no more than three drinks at a sitting.  

The `HELPsmall` dataset includes baseline data from a randomized clinical trial (Health Evaluation and Linkage to Primary Care).  

```{r eval=FALSE}
HELPsmall <- read_csv(http://www.amherst.edu/~nhorton/HELPsmall.csv")
```

variable|description
-------|------
sex|gender of subject `female` or `male`
i1|average number of drinks per day (in last 30 days)
i2|maximum number of drinks per day (in past 30 days)
age|age (in years)


Use these guidelines and the `HELPsmall` dataset to create a new variable called `abstinent` for those that reported no drinking based on the value of their `i1` variable and `moderate` for those that do not exceed the NIAAA guidelines.  All other non-missing values should be coded as `highrisk`.

```{r}
HELPsmall <- HELPmiss %>%
  mutate(i1 = ifelse(id==1, NA, i1)) %>%  # make one value missing
  select(sex, i1, i2, age)
```

```{r}
glimpse(HELPsmall)

attach(HELPsmall)   # needed to work around case_when issue of scoping
# I definitely want to remove these ASAP

HELPsmall <- HELPsmall %>%
  mutate(drink_stat = case_when(
    i1 == 0 ~ "abstinent",
    i1 <= 1 & i2 <= 3 & sex=='female' ~ "moderate",
    i1 <= 1 & i2 <= 3 & sex=='male' & age >= 65 ~ "moderate",
    i1 <= 2 & i2 <= 4 & sex=='male' ~ "moderate",
    TRUE ~ "highrisk"
))
detach(HELPsmall)
tally( ~ drink_stat, data = HELPsmall)
```

### Task 2: creating categorical variable (substance involvement )

Subjects in the HELP study were categorized into categories of drug and alcohol involvement, as displayed in the following table.

```{r}
HELPbase <- HELPfull %>%
  filter(TIME==0)
tally( ~ PRIM_SUB + SECD_SUB, data=HELPbase)
```

Note that the following codings of substance use involvement were used:

value|description
-----|-----------
0|None
1|Alcohol
2|Cocaine
3|Heroin
4|Barbituates
5|Benzos
6|Marijuana
7|Methadone
8|Opiates

Create a new variable called `primsub` that combines the primary and secondary substances into a categorical variable with values corresponding to primary and secondary substances of the form: `alcohol only`, `cocaine only`, `heroin only`, `alcohol-cocaine`, `cocaine-alcohol`, or `other`.  Code any group with fewer than 5 entries as `alcohol-other`, `cocaine-other`, or `heroin-other`.  If `PRIM_SUB==6` make the `primsub` variable missing.

How many subjects are there in the `alcohol-none` group?  How many subjects are there in the `alcohol-other` group?  What are the three most common groups?

```{r}
attach(HELPbase)
HELPbase <- HELPbase %>%
  mutate(primary=
    recode(PRIM_SUB, 
      `1`="alcohol",
      `2`="cocaine",
      `3`="heroin",
      `4`="barbituates",
      `5`="benzos",
      `6`="marijuana",
      `7`="methadone",
      `8`="opiates"),
    second=recode(SECD_SUB,
      `0`="none",
      `1`="alcohol",
      `2`="cocaine",
      `3`="heroin",
      `4`="barbituates",
      `5`="benzos",
      `6`="marijuana",
      `7`="methadone",
      `8`="opiates"),
    title=paste0(primary, "-", second) 
)
detach(HELPbase)
tally(~ primary, data=HELPbase)
tally(~ second, data=HELPbase)

counts <- HELPbase %>%
  group_by(primary, second) %>%
  summarise(observed=n())

merged <- left_join(HELPbase, counts, by=c("primary", "second"))

attach(merged)
merged <- merged %>%
  mutate(
    title = 
      case_when(
        observed < 5 & primary=="alcohol" ~ "alcohol-other",
        observed < 5 & primary=="cocaine" ~ "cocaine-other",
        observed < 5 & primary=="heroin" ~ "heroin-other",
        TRUE ~ title),
    title = ifelse(primary=="marijuana", NA, title))
detach(merged)
tally(~ title + observed, data=merged)

```

Answers:

```{r}
tally(~ title=="alcohol-none", data=merged)
tally(~ title=="alcohol-other", data=merged)
sort(tally(~ title, data=merged), decreasing=TRUE)[1:3]
```
